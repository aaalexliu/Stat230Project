---
title: "GroupDProgress"
author: "Alex Liu, Rana Barghout, Daniel Njoo"
date: "November 29, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(cache = TRUE)
```

### Libraries
```{r libraries, message=F}
library(tidyverse)
library(ggplot2)
library(xts)
library(mosaic)
library(lubridate)
```

### Data loading
```{r load data, warning=F}
swipe_data<-read.csv('./GroupDDataset.csv')
swipe_data$date <- as.Date(swipe_data[,'date'], format = '%m/%d/%y')
processed_tags <- read.csv('./valscraper/val_t60_simplified.csv')
processed_tags$date <- as.Date(processed_tags[,'date'], format = '%m/%d/%y')
swipe_data2 <- left_join(swipe_data, processed_tags, by = c('date', 'type'))
```

### Initial wrangle
```{r wrangle, warning=F}
swipes <- swipe_data2[,c('date', 'count', 'Events', 'semester', 'type', 'tag_cluster_t75', 'tag_cluster_t69', 'tag_cluster_t66')]
school_only <- filter(swipes, semester == 'Fall' | semester == 'Spring')
tagged <- school_only
tagged <- subset(tagged, tag_cluster_t75 != '')
tagged$tag_cluster_t75 <- factor(tagged$tag_cluster_t75)
str(tagged)
```

After examining the tagged data, we find that summer data is still included, and has NA values for count. Since our project goal is to look at Val during normal school year operations, we exclude summer data. We also do not have swipe data for the school year 2017-2018, and na.omit removes these as well

### Further wrangling
```{r wrangle2}
cleaned <- na.omit(tagged)
levels(cleaned$Events)[levels(cleaned$Events) == ""] <- "No Event"
colnames(cleaned) <- c('date', 'count', 'event', 'semester', 'type', 'tag75', 'tag69', 'tag66')
cleaned$substitute_time[cleaned$type == "Breakfast"] = "8:00:00"
cleaned$substitute_time[cleaned$type == "Lunch"] = "13:00:00"
cleaned$substitute_time[cleaned$type == "Dinner"] = "18:00:00"
cleaned$datetime <- paste(cleaned$date, cleaned$substitute_time)
cleaned$posix <- as.POSIXct(cleaned$datetime, format = '%Y-%m-%d %H:%M:%S')
cleaned$weekday <- weekdays(cleaned$posix)
str(cleaned)
```

### Initial model
```{r mod}
mod<-cleaned %>% lm(count~weekday+tag75+type+event, data=.)
summary(mod)$r.squared
summary(mod)$adj.r.squared
```

### Improvements
```{r}
which(summary(mod)$coefficients[,4] > 0.05)
length(which(summary(mod)$coefficients[,4] > 0.05)) #24 insignificant coefficients
length(which(summary(mod)$coefficients[,4] < 0.05)) #69 significant ones, including all non-meal types
```

A quick look at the insignificant (at a 5% SL) terms in our initial MLR shows us that it's mainly certain meal types (and a few events such as Family Weekend and Homecoming Weekend) that aren't significant. This will have to be addressed in a future model, i.e. by clustering them further based on their effects on Val swipe count.

Additionally, the current model is relatively predictive, $r^2$ of 74.4% with mostly significant predictors (noted by decent convergence between adjusted and non-adjusted). We plan to add additional variables to increase our model's predictive power, including but not limited to the week into a given semester a meal takes places during - something we noted in our Outline is correlated to Val swipe count.
